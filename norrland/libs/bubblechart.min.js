!function(e){function t(a){if(i[a])return i[a].exports;var r=i[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var i={};t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,a){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=8)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(5);var a=i(1),r=function(e){return e&&e.__esModule?e:{default:e}}(a),s={version:"1.0.25",build:1513414820356};t.default=Vizabi.Tool.extend("BubbleChart",{init:function(e,t){this.name="bubblechart",this.components=[{component:r.default,placeholder:".vzb-tool-viz",model:["state.time","state.marker","locale","ui"]},{component:Vizabi.Component.get("timeslider"),placeholder:".vzb-tool-timeslider",model:["state.time","state.marker","ui"]},{component:Vizabi.Component.get("dialogs"),placeholder:".vzb-tool-dialogs",model:["state","ui","locale"]},{component:Vizabi.Component.get("buttonlist"),placeholder:".vzb-tool-buttonlist",model:["state","ui","locale"]},{component:Vizabi.Component.get("treemenu"),placeholder:".vzb-tool-treemenu",model:["state.marker","state.marker_tags","state.time","locale"]},{component:Vizabi.Component.get("datawarning"),placeholder:".vzb-tool-datawarning",model:["locale"]},{component:Vizabi.Component.get("datanotes"),placeholder:".vzb-tool-datanotes",model:["state.marker","locale"]},{component:Vizabi.Component.get("steppedspeedslider"),placeholder:".vzb-tool-stepped-speed-slider",model:["state.time","locale"]}],this._super(e,t)},validate:function(e){if(e=this.model||e,this._super(e),e.ui.chart.lockNonSelected&&(!e.ui.splash||!1===e.state.time.splash)){var t=e.state.time.parse(""+e.ui.chart.lockNonSelected);t<e.state.time.start&&(e.ui.chart.lockNonSelected=e.state.time.formatDate(e.state.time.start)),t>e.state.time.end&&(e.ui.chart.lockNonSelected=e.state.time.formatDate(e.state.time.end))}},default_model:{state:{time:{autoconfig:{type:"time"}},entities:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},entities_colorlegend:{autoconfig:{type:"entity_domain",excludeIDs:["tag"]}},entities_tags:{autoconfig:{type:"entity_domain",includeOnlyIDs:["tag"]}},marker_tags:{space:["entities_tags"],label:{use:"property",which:"name"},hook_parent:{}},marker:{space:["entities","time"],axis_x:{use:"indicator",autoconfig:{index:0,type:"measure"}},axis_y:{use:"indicator",autoconfig:{index:1,type:"measure"}},label:{use:"property",autoconfig:{includeOnlyIDs:["name"],type:"string"}},size:{autoconfig:{index:2,type:"measure"}},color:{syncModels:["marker_colorlegend"],autoconfig:{}},size_label:{use:"constant",which:"_default",scaleType:"ordinal",_important:!1,extent:[0,.33],allow:{names:["_default"]}}},marker_colorlegend:{space:["entities_colorlegend"],label:{use:"property",which:"name"},hook_rank:{use:"property",which:"rank"},hook_geoshape:{use:"property",which:"shape_lores_svg"}}},locale:{},ui:{chart:{superhighlightOnMinimapHover:!0,whenHovering:{showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},labels:{dragging:!0,removeLabelBox:!1},margin:{left:0,top:0},trails:!0,lockNonSelected:0},datawarning:{doubtDomain:[],doubtRange:[]},show_ticks:!0,presentation:!1,panWithArrow:!1,adaptMinMaxZoom:!1,cursorMode:"arrow",zoomOnScrolling:!1,buttons:["colors","find","zoom","trails","lock","moreoptions","fullscreen","presentation"],dialogs:{popup:["colors","find","size","zoom","moreoptions"],sidebar:["colors","find","size","zoom"],moreoptions:["opacity","speed","axes","size","colors","label","zoom","presentation","about"]}}},versionInfo:s})},function(e,t,i){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=i(3),s=a(r),l=i(2),o=a(l),n=Vizabi,c=n.utils,h=Vizabi.helpers,d=h.svgexport,u=h.labels,m=h["d3.axisWithLabelPicker"],g=h["d3.dynamicBackground"],x=Vizabi.iconset,v=x.warn,f=x.question,y=Vizabi.Component.extend("bubblechart",{init:function(e,t){var a=this,r=this;this.name="bubblechart",this.template=i(6),this.model_expects=[{name:"time",type:"time"},{name:"marker",type:"marker"},{name:"locale",type:"locale"},{name:"ui",type:"ui"}],this.model_binds={"change:time.playing":function(e,t){c.isTouchDevice()&&r.model.time.playing&&r.someHighlighted&&r.model.marker.clearHighlighted()},"change:time.start":function(e,t){if(r._readyOnce&&!r.model.time.splash)return["color","axis_x","axis_y"].filter(function(e){return r.model.marker[e].which==r.model.time.dim}).length?void r.ready():void r._trails.create().then(function(){r._trails.run(["findVisible","reveal","opacityHandler"])})},"change:time.end":function(e,t){if(r._readyOnce&&!r.model.time.splash)return["color","axis_x","axis_y"].filter(function(e){return r.model.marker[e].which==r.model.time.dim}).length?void r.ready():void r._trails.create().then(function(){r._trails.run(["findVisible","reveal","opacityHandler"])})},"change:time.record":function(){r.model.time.record?r._export.open(this.element,this.name):r._export.reset()},"change:ui.chart.trails":function(e){r._readyOnce&&(r._trails.toggle(r.model.ui.chart.trails),r.redrawDataPoints())},"change:ui.chart.lockNonSelected":function(e){r._readyOnce&&r.redrawDataPoints(500)},"change:marker":function(e,t){if(r._readyOnce){if(t.indexOf("scaleType")>-1)return void r.ready();if(-1===t.indexOf("marker.color")&&-1===t.indexOf("marker.size")&&-1===t.indexOf("marker.size_label"))if(t.indexOf("domainMin")>-1||t.indexOf("domainMax")>-1){if(!r.yScale||!r.xScale)return;r.updateSize(),r.updateMarkerSizeLimits(),r._trails.run("findVisible"),r.redrawDataPoints(),r._trails.run("resize",null,500)}else if(t.indexOf("zoomedMin")>-1||t.indexOf("zoomedMax")>-1){if(r.draggingNow)return;if(c.approxEqual(r._zoomedXYMinMax.axis_x.zoomedMin,r.model.marker.axis_x.zoomedMin,.01)&&c.approxEqual(r._zoomedXYMinMax.axis_x.zoomedMax,r.model.marker.axis_x.zoomedMax,.01)&&c.approxEqual(r._zoomedXYMinMax.axis_y.zoomedMin,r.model.marker.axis_y.zoomedMin,.01)&&c.approxEqual(r._zoomedXYMinMax.axis_y.zoomedMax,r.model.marker.axis_y.zoomedMax,.01))return;var i=!1;r.model.time.playing&&(i=!0,r.model.time.pause(!0)),r._trails.run("abortAnimation"),r._panZoom.zoomToMaxMin(r.model.marker.axis_x.getZoomedMin(),r.model.marker.axis_x.getZoomedMax(),r.model.marker.axis_y.getZoomedMin(),r.model.marker.axis_y.getZoomedMax(),500,"don't feed these zoom values back to state"),i&&(r.model.time.postponePause=!1)}}},"change:marker.select":function(e,t){r._readyOnce&&r.entityBubbles&&((e.source._val||[]).length-(e.source._previousVal||[]).length>50&&(r.model.ui.chart.trails=!1),r.selectDataPoints(),r.redrawDataPoints(),r._trails.create().then(function(){r._trails.run(["findVisible","reveal","opacityHandler"])}),r.updateBubbleOpacity(),r._updateDoubtOpacity())},"change:marker.superHighlight":function(e,t){a._readyOnce&&a._blinkSuperHighlighted()},"change:marker.highlight":function(e,t){if(r._readyOnce)if("highlight"==t)r.highlightDataPoints();else if(null!==t){var i=r._formatSTitleValues(t.size,t.color);r._updateSTitle(i[0],i[1])}else r._updateSTitle()},"change:time.value":function(){!r.model.time.splash&&r._readyOnce&&r.entityBubbles&&(r.calculationQueue?r.calculationQueue.push(r.model.time.value.toString()):r.calculationQueue=[r.model.time.value.toString()],function(e){r.model.marker.getFrame(e,function(e,t){if(!r._frameIsValid(e))return c.warn("change:time.value: empty data received from marker.getFrame(). doing nothing");var i=r.calculationQueue.indexOf(t.toString());-1!=i&&(r.calculationQueue.splice(0,i+1),r.frameChanged(e,t))})}(r.model.time.value))},"change:ui.adaptMinMaxZoom":function(){r.model.ui.adaptMinMaxZoom?r._panZoom.expandCanvas(500):r._panZoom.reset()},"change:marker.size.extent":function(e,t){r._readyOnce&&(r.updateMarkerSizeLimits(),r.redrawDataPointsOnlySize(),r._trails.run("resize"))},"change:marker.color":function(e,t){r._readyOnce&&(r.redrawDataPointsOnlyColors(),r._trails.run("recolor"))},"change:marker.opacitySelectDim":function(){r.updateBubbleOpacity()},"change:marker.opacityRegular":function(){r.updateBubbleOpacity(),r._trails.run("opacityHandler")},"change:ui.cursorMode":function(){var e=r.chartSvg;"plus"===r.model.ui.cursorMode?(e.classed("vzb-zoomin",!0),e.classed("vzb-zoomout",!1),e.classed("vzb-panhand",!1)):"minus"===r.model.ui.cursorMode?(e.classed("vzb-zoomin",!1),e.classed("vzb-zoomout",!0),e.classed("vzb-panhand",!1)):"hand"===r.model.ui.cursorMode?(e.classed("vzb-zoomin",!1),e.classed("vzb-zoomout",!1),e.classed("vzb-panhand",!0)):(e.classed("vzb-zoomin",!1),e.classed("vzb-zoomout",!1),e.classed("vzb-panhand",!1))},"change:marker.space":function(){r.someHighlighted&&r.model.marker.clearHighlighted(),r.someSelected&&r.model.marker.clearSelected()},ready:function(){}},this._super(e,t),this.xScale=null,this.yScale=null,this.sScale=null,this.cScale=null,this.xAxis=m("bottom"),this.yAxis=m("left"),r.COLOR_BLACKISH="#333",r.COLOR_WHITEISH="#fdfdfd",this.isCanvasPreviouslyExpanded=!1,this.draggingNow=null,this._trails=new s.default(this),this._panZoom=new o.default(this),this._export=new d(this),this._export.prefix("vzb-bc-").deleteClasses(["vzb-bc-bubbles-crop","vzb-hidden","vzb-bc-year","vzb-bc-zoom-rect","vzb-bc-projection-x","vzb-bc-projection-y","vzb-bc-axis-c-title"]),this._labels=new u(this),this._labels.config({CSS_PREFIX:"vzb-bc",LABELS_CONTAINER_CLASS:"vzb-bc-labels",LINES_CONTAINER_CLASS:"vzb-bc-bubbles",LINES_CONTAINER_SELECTOR_PREFIX:"bubble-"})},_rangeBump:function(e,t){var i=this.activeProfile.maxRadiusPx/2;if(t=t?-1:1,c.isArray(e)&&e.length>1){var a=e[0],r=e[e.length-1];return a<r?(a+=i*t,r-=i*t,a>r&&(a=r=(a+r)/2)):a>r&&(a-=i*t,r+=i*t,a<r&&(a=r=(a+r)/2)),[a,r]}c.warn("rangeBump error: input is not an array or empty")},readyOnce:function(){var e=this;this._readyOnce=!1,this.scrollableAncestor=c.findScrollableAncestor(this.element),this.element=d3.select(this.element),this.chartSvg=this.element.select("svg"),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisElContainer=this.graph.select(".vzb-bc-axis-y"),this.yAxisEl=this.yAxisElContainer.select("g"),this.xAxisElContainer=this.graph.select(".vzb-bc-axis-x"),this.xAxisEl=this.xAxisElContainer.select("g"),this.ySubTitleEl=this.graph.select(".vzb-bc-axis-y-subtitle"),this.xSubTitleEl=this.graph.select(".vzb-bc-axis-x-subtitle"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.sTitleEl=this.graph.select(".vzb-bc-axis-s-title"),this.cTitleEl=this.graph.select(".vzb-bc-axis-c-title"),this.yearEl=this.graph.select(".vzb-bc-year"),this.year=new g(this.yearEl),this.yInfoEl=this.graph.select(".vzb-bc-axis-y-info"),this.xInfoEl=this.graph.select(".vzb-bc-axis-x-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.projectionX=this.graph.select(".vzb-bc-projection-x"),this.projectionY=this.graph.select(".vzb-bc-projection-y"),this.lineEqualXY=this.graph.select(".vzb-bc-line-equal-xy"),this.trailsContainer=this.graph.select(".vzb-bc-trails"),this.bubbleContainerCrop=this.graph.select(".vzb-bc-bubbles-crop"),this.zoomSelection=this.graph.select(".vzb-zoom-selection"),this.labelsContainerCrop=this.graph.select(".vzb-bc-labels-crop"),this.bubbleContainer=this.graph.select(".vzb-bc-bubbles"),this.labelsContainer=this.graph.select(".vzb-bc-labels"),this.linesContainer=this.graph.select(".vzb-bc-lines"),this.zoomRect=this.element.select(".vzb-bc-zoom-rect"),this.eventArea=this.element.select(".vzb-bc-eventarea"),this.entityBubbles=null,this.bubbleCrown=this.element.select(".vzb-bc-bubble-crown"),this.bubbleCrown.selectAll(".vzb-crown-glow").attr("filter","url("+location.pathname+"#vzb-glow-filter)"),this.tooltipMobile=this.element.select(".vzb-tooltip-mobile"),this.on("resize",function(){e._trails.run("abortAnimation"),e.updateSize()||(e.updateMarkerSizeLimits(),e._labels.updateSize(),function(t,i,a,r){e._panZoom.zoomer.dontFeedToState=!0,e._panZoom.rerun(),e._panZoom.zoomToMaxMin(t,i,a,r,0,!0)}(e._zoomedXYMinMax.axis_x.zoomedMin,e._zoomedXYMinMax.axis_x.zoomedMax,e._zoomedXYMinMax.axis_y.zoomedMin,e._zoomedXYMinMax.axis_y.zoomedMax))}),d3.select("body").on("keydown",function(){"arrow"!==e.model.ui.cursorMode&&"hand"!==e.model.ui.cursorMode||(d3.event.metaKey||d3.event.ctrlKey)&&e.element.select("svg").classed("vzb-zoomin",!0)}).on("keyup",function(){"arrow"!==e.model.ui.cursorMode&&"hand"!==e.model.ui.cursorMode||d3.event.metaKey||d3.event.ctrlKey||e.element.select("svg").classed("vzb-zoomin",!1)}).on("mouseenter",function(){"arrow"!==e.model.ui.cursorMode&&"hand"!==e.model.ui.cursorMode||d3.event.metaKey||d3.event.ctrlKey||e.element.select("svg").classed("vzb-zoomin",!1)}),this.root.on("resetZoom",function(){e._panZoom.reset(null,500)}),this._panZoom.zoomSelection(this.bubbleContainerCrop),this.bubbleContainerCrop.call(this._panZoom.dragRectangle).call(this._panZoom.zoomer).on("dblclick.zoom",null).on("mouseup",function(){e.draggingNow=!1}).on("click",function(){var t=e.model.ui.cursorMode;d3.event.defaultPrevented||"arrow"===t||"hand"===t||e._panZoom.zoomByIncrement(t,500)}),this.TIMEDIM=this.model.time.getDimension(),this.KEYS=c.unique(this.model.marker._getAllDimensions({exceptType:"time"})),this.KEY=this.KEYS.join(","),this.dataKeys=this.model.marker.getDataKeysPerHook(),this.labelNames=this.model.marker.getLabelHookNames(),this.updateUIStrings(),this.wScale=d3.scaleLinear().domain(this.model.ui.datawarning.doubtDomain).range(this.model.ui.datawarning.doubtRange),this._labels.readyOnce(),e._readyOnce=!0},_frameIsValid:function(e){return!(!e||0===Object.keys(e.axis_y).length||0===Object.keys(e.axis_x).length||0===Object.keys(e.size).length)},ready:function(){var e=this;this.KEYS=c.unique(this.model.marker._getAllDimensions({exceptType:"time"})),this.KEY=this.KEYS.join(","),this.dataKeys=this.model.marker.getDataKeysPerHook(),this.labelNames=this.model.marker.getLabelHookNames(),this.updateUIStrings();this.model.time.end;this.updateIndicators(),this.updateTime(),e.model.time.splash||e._trails.create(),this.model.marker.getFrame(this.model.time.value,function(t,i){return i.toString()!=e.model.time.value.toString()?void c.defer(function(){e.ready()}):e._frameIsValid(t)?(e.frame=t,e.updateSize(),e.updateMarkerSizeLimits(),e.updateEntities(),e._labels.ready(),e.redrawDataPoints(),e.selectDataPoints(),e.updateBubbleOpacity(),e._updateDoubtOpacity(),e.zoomToMarkerMaxMin(),e.model.time.splash||e._trails.run(["findVisible","reveal","opacityHandler"]),void(e.model.ui.adaptMinMaxZoom&&e._panZoom.expandCanvas())):c.warn("ready: empty data received from marker.getFrame(). doing nothing")})},zoomToMarkerMaxMin:function(){this._panZoom.resetZoomState();var e=this.model.marker.axis_x,t=this.model.marker.axis_y,i=(e.getScale().domain(),t.getScale().domain(),e.getZoomedMin()),a=e.getZoomedMax(),r=t.getZoomedMin(),s=t.getZoomedMax();this._panZoom.zoomToMaxMin(i,a,r,s,0,"don't feed these zoom values back to state")},updateIndicators:function(){var e=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.sScale=this.model.marker.size.getScale(),this.cScale=this.model.marker.color.getScale(),this._labels.setScales(this.xScale,this.yScale),this.yAxis.tickFormat(e.model.marker.axis_y.getTickFormatter()),this.xAxis.tickFormat(e.model.marker.axis_x.getTickFormatter())},frameChanged:function(e,t){this.frame=e,this.updateTime(),this._updateDoubtOpacity(),this._trails.run("findVisible"),this.model.ui.adaptMinMaxZoom?this._panZoom.expandCanvas():this.redrawDataPoints(),this._trails.run("reveal",null,this.duration),this.tooltipMobile.classed("vzb-hidden",!0),this._reorderEntities()},_getSubtitle:function(e,t){var i=e.replace(t,"");","===i[0]&&(i=i.slice(1));var a=/^\((.*)\)$|.*/.exec(i.trim());return a[1]||a[0]||""},updateUIStrings:function(){var e=this,t=(this.getLayoutProfile(),e.model.marker.axis_y.getConceptprops()),i=e.model.marker.axis_x.getConceptprops(),a=e.model.marker.size.getConceptprops(),r=e.model.marker.color.getConceptprops();this.translator=this.model.locale.getTFunction(),this.strings={title:{Y:t.name,X:i.name,S:a.name,C:r.name},title_short:{Y:t.name_short,X:i.name_short,S:a.name_short,C:r.name_short},subtitle:{Y:this._getSubtitle(t.name,t.name_short),X:this._getSubtitle(i.name,i.name_short),S:a.name_short,C:r.name_short},unit:{Y:t.unit||"",X:i.unit||"",S:a.unit||"",C:r.unit||""}},this.ySubTitleEl.selectAll("text").data([0]).enter().append("text"),this.xSubTitleEl.selectAll("text").data([0]).enter().append("text");var s=this.yTitleEl.selectAll("text").data([0]);s.enter().append("text"),s.on("click",function(){e.parent.findChildByName("gapminder-treemenu").markerID("axis_y").alignX(e.model.locale.isRTL()?"right":"left").alignY("top").updateView().toggle()});var l=this.xTitleEl.selectAll("text").data([0]);l.enter().append("text"),l.on("click",function(){e.parent.findChildByName("gapminder-treemenu").markerID("axis_x").alignX(e.model.locale.isRTL()?"right":"left").alignY("bottom").updateView().toggle()});var o=this.sTitleEl.selectAll("text").data([0]);o.enter().append("text"),o.attr("text-anchor","end"),c.setIcon(this.dataWarningEl,v).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").attr("text-anchor","end").text(this.translator("hints/dataWarning")),c.setIcon(this.yInfoEl,f).select("svg").attr("width","0px").attr("height","0px").style("opacity",Number(Boolean(t.description||t.sourceLink))),c.setIcon(this.xInfoEl,f).select("svg").attr("width","0px").attr("height","0px").style("opacity",Number(Boolean(i.description||i.sourceLink))),this.yInfoEl.on("click",function(){e.parent.findChildByName("gapminder-datanotes").pin()}),this.yInfoEl.on("mouseover",function(){var t=this.getBBox(),i=c.makeAbsoluteContext(this,this.farthestViewportElement)(t.x-10,t.y+t.height+10),a=e.root.element.getBoundingClientRect(),r=e.element.node().getBoundingClientRect();e.parent.findChildByName("gapminder-datanotes").setHook("axis_y").show().setPos(i.x+r.left-a.left,i.y)}),this.yInfoEl.on("mouseout",function(){e.parent.findChildByName("gapminder-datanotes").hide()}),this.xInfoEl.on("click",function(){e.parent.findChildByName("gapminder-datanotes").pin()}),this.xInfoEl.on("mouseover",function(){if(!e.model.time.dragging){var t=this.getBBox(),i=c.makeAbsoluteContext(this,this.farthestViewportElement)(t.x-10,t.y+t.height+10),a=e.root.element.getBoundingClientRect(),r=e.element.node().getBoundingClientRect();e.parent.findChildByName("gapminder-datanotes").setHook("axis_x").show().setPos(i.x+r.left-a.left,i.y)}}),this.xInfoEl.on("mouseout",function(){e.model.time.dragging||e.parent.findChildByName("gapminder-datanotes").hide()}),this.dataWarningEl.on("click",function(){e.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){e._updateDoubtOpacity(1)}).on("mouseout",function(){e._updateDoubtOpacity()})},_updateDoubtOpacity:function(e){null==e&&(e=this.wScale(+this.model.time.formatDate(this.time))),this.someSelected&&(e=1),this.dataWarningEl.style("opacity",e)},updateEntities:function(){var e=this,t=this.dataKeys,i=this.KEYS,a=this.KEY,r=this.TIMEDIM,s=function(s){return s=s||"",e.model.marker.getKeys().map(function(o){var n=Object.assign({},o);return n[r]=l,n.sortValue=e.frame.size[c.getKey(o,t.size)]||0,n[a]=s+c.getKey(o,i),n}).sort(function(e,t){return t.sortValue-e.sortValue})},l=this.model.time.end,o=s.call(this);this.model.marker.setVisible(o),this.model.time.splash||this.unselectBubblesWithNoData(o),this.entityBubbles=this.bubbleContainer.selectAll("circle.vzb-bc-entity").data(this.model.marker.getVisible(),function(e){return e[a]}),this.entityBubbles.exit().remove(),this.entityBubbles=this.entityBubbles.enter().append("circle").attr("class",function(e){return"vzb-bc-entity bubble-"+e[a]}).on("mouseover",function(t,i){c.isTouchDevice()||"arrow"!==e.model.ui.cursorMode&&"hand"!==e.model.ui.cursorMode||e._bubblesInteract().mouseover(t,i)}).on("mouseout",function(t,i){c.isTouchDevice()||"arrow"!==e.model.ui.cursorMode&&"hand"!==e.model.ui.cursorMode||e._bubblesInteract().mouseout(t,i)}).on("click",function(t,i){c.isTouchDevice()||"arrow"!==e.model.ui.cursorMode&&"hand"!==e.model.ui.cursorMode||e._bubblesInteract().click(t,i)}).onTap(function(t,i){d3.event.stopPropagation(),e._bubblesInteract().click(t,i)}).onLongTap(function(e,t){}).merge(this.entityBubbles),this._reorderEntities()},unselectBubblesWithNoData:function(e){var t=this,i=this.KEYS,a=this.KEY;if(this.model.marker.select.length){var r=[],s=e.map(function(e){return e[a]});this.model.marker.select.forEach(function(e){-1!==s.indexOf(c.getKey(e,i))&&r.push(e)}),r.length!==t.model.marker.select.length&&(t.model.marker.select=r)}},_reorderEntities:function(){var e=this,t=this.dataKeys,i=this.KEY;this.bubbleContainer.selectAll(".vzb-bc-entity").sort(function(a,r){var s=e.frame.size[c.getKey(a,t.size)],l=e.frame.size[c.getKey(r,t.size)];return"undefined"===typeof s&&"undefined"!==typeof l?-1:"undefined"!==typeof s&&"undefined"===typeof l?1:s!=l?d3.descending(s,l):a[i]!=r[i]?d3.ascending(a[i],r[i]):"undefined"!==typeof a.trailStartTime||"undefined"!==typeof r.trailStartTime?"undefined"!==typeof a.trailStartTime?-1:1:"undefined"!==typeof a.status||"undefined"!==typeof r.status?"undefined"!==typeof a.status?-1:1:d3.descending(s,l)})},_bubblesInteract:function(){var e=this;this.KEY,this.TIMEDIM;return{mouseover:function(t,i){e.model.marker.highlightMarker(t),e._labels.showCloseCross(t,!0)},mouseout:function(t,i){e.model.marker.clearHighlighted(),e._labels.showCloseCross(t,!1)},click:function(t,i){if(!e.draggingNow){var a=e.model.marker.isSelected(t);e.model.marker.selectMarker(t),c.isTouchDevice()||(a&&e.model.marker.highlightMarker(t),e.highlightDataPoints())}}}},updateTime:function(){this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-this.time_1>0?this.model.time.delayAnimations:0,this.year.setText(this.model.time.formatDate(this.time,"ui"),this.duration)},updateSize:function(){var e=this.chartSvg,t=c.px2num(e.style("width")),i=c.px2num(e.style("height")),a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e+i*t},r=function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e+t*i},s={small:{margin:{top:30,bottom:35,left:30,right:10},leftMarginRatio:1,padding:2,minRadiusPx:.5,maxRadiusEm:this.model.ui.chart.maxRadiusEm||.05,infoElHeight:16,yAxisTitleBottomMargin:6,xAxisTitleBottomMargin:4},medium:{margin:{top:15,bottom:40,left:40,right:15},leftMarginRatio:1.6,padding:2,minRadiusPx:1,maxRadiusEm:this.model.ui.chart.maxRadiusEm||.05,infoElHeight:20,yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:4},large:{margin:{top:15,bottom:a(30,.03),left:r(31,.015),right:20},leftMarginRatio:1.8,padding:2,minRadiusPx:1,maxRadiusEm:this.model.ui.chart.maxRadiusEm||.05,infoElHeight:22,yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:a(0,.01),hideSTitle:!0}},l={medium:{margin:{top:20,bottom:55,left:50,right:20},yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:4,infoElHeight:26},large:{margin:{top:30,bottom:a(45,.03),left:r(35,.025),right:30},yAxisTitleBottomMargin:3,xAxisTitleBottomMargin:a(-10,.01),infoElHeight:32,hideSTitle:!0}},o=this;this.activeProfile=this.getActiveProfile(s,l);var n=this.getLayoutProfile(),h=this.root.getVizWidthHeight();this.activeProfile.maxRadiusPx=Math.max(this.activeProfile.minRadiusPx,this.activeProfile.maxRadiusEm*c.hypotenuse(h.width,h.height));var d=this.activeProfile.margin,u=this.activeProfile.infoElHeight;if(o._labels.setCloseCrossHeight(1.2*o.activeProfile.infoElHeight),o._labels.setTooltipFontSize(o.activeProfile.infoElHeight+"px"),this.height=parseInt(this.element.style("height"),10)-d.top-d.bottom||0,this.width=parseInt(this.element.style("width"),10)-d.left*this.activeProfile.leftMarginRatio-d.right||0,(this.height<=0||this.width<=0)&&(this.height=0,this.width=0,c.warn("Bubble chart updateSize(): vizabi container is too little or has display:none")),this.graph.attr("transform","translate("+d.left*this.activeProfile.leftMarginRatio+","+d.top+")"),this.year.resize(this.width,this.height),this.eventArea.attr("width",this.width).attr("height",Math.max(0,this.height)),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range(this._rangeBump([this.height,0])):this.yScale.rangePoints([this.height,0],o.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range(this._rangeBump([0,this.width])):this.xScale.rangePoints([0,this.width],o.activeProfile.padding).range(),this.yAxis.scale(this.yScale).tickSizeInner(-this.width).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.width,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:d,limitMaxTickNumber:6,bump:this.activeProfile.maxRadiusPx/2,viewportLength:this.height,formatter:this.model.marker.axis_y.getTickFormatter()}),this.xAxis.scale(this.xScale).tickSizeInner(-this.height).tickSizeOuter(0).tickPadding(6).tickSizeMinor(-this.height,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:d,bump:this.activeProfile.maxRadiusPx/2,viewportLength:this.width,formatter:this.model.marker.axis_x.getTickFormatter()}),this.bubbleContainerCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.labelsContainerCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.xAxisElContainer.attr("width",this.width+1).attr("height",this.activeProfile.margin.bottom+this.height).attr("y",-1).attr("x",-1),this.xAxisEl.attr("transform","translate(1,"+(1+this.height)+")"),this.yAxisElContainer.attr("width",this.activeProfile.margin.left+this.width).attr("height",Math.max(0,this.height)).attr("x",-this.activeProfile.margin.left),this.yAxisEl.attr("transform","translate("+(this.activeProfile.margin.left-1)+",0)"),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.projectionX.attr("y1",o.yScale.range()[0]+this.activeProfile.maxRadiusPx/2),this.projectionY.attr("x2",o.xScale.range()[0]-this.activeProfile.maxRadiusPx/2),this._updateSTitle(),this.sTitleEl.attr("transform","translate("+this.width+",20) rotate(-90)"),"small"!==n)this.ySubTitleEl.select("text").attr("dy",.6*u).text(this.strings.subtitle.Y),this.xSubTitleEl.select("text").attr("dy",.3*-u).text(this.strings.subtitle.X),this.yTitleEl.select("text").text(this.strings.title_short.Y+" ").append("tspan").style("font-size",.7*u+"px").text("▼"),this.xTitleEl.select("text").text(this.strings.title_short.X+" ").append("tspan").style("font-size",.7*u+"px").text("▼");else{this.ySubTitleEl.select("text").text(""),this.xSubTitleEl.select("text").text("");var m=this.yTitleEl.select("text").text(this.strings.title.Y);m.node().getBBox().width>this.width&&m.text(this.strings.title_short.Y);var g=this.xTitleEl.select("text").text(this.strings.title.X);g.node().getBBox().width>this.width-100&&g.text(this.strings.title_short.X)}var x=this.model.locale.isRTL();if(this.ySubTitleEl.style("font-size",.8*u+"px").attr("transform","translate(0,0) rotate(-90)"),this.xSubTitleEl.style("font-size",.8*u+"px").attr("transform","translate("+this.width+","+this.height+")"),this.yTitleEl.style("font-size",u+"px").attr("transform","small"!==n?"translate("+(-d.left-this.activeProfile.yAxisTitleBottomMargin)+","+.5*this.height+") rotate(-90)":"translate("+(x?this.width:10-this.activeProfile.margin.left)+", -"+this.activeProfile.yAxisTitleBottomMargin+")"),this.xTitleEl.style("font-size",u+"px").attr("transform","small"!==n?"translate("+.5*this.width+","+(this.height+d.bottom-this.activeProfile.xAxisTitleBottomMargin)+")":"translate("+(x?this.width:0)+","+(this.height+d.bottom-this.activeProfile.xAxisTitleBottomMargin)+")"),this.yInfoEl.select("svg").node()){var v=this.yTitleEl.node().getBBox(),f=c.transform(this.yTitleEl.node()),y=x?v.x+f.translateX-1.4*u:v.x+f.translateX+v.width+.4*u,b=x?f.translateY+1.4*u+.5*v.width:f.translateY-.4*u-.5*v.width;this.yInfoEl.select("svg").attr("width",u+"px").attr("height",u+"px"),this.yInfoEl.attr("transform","small"!==n?"translate("+(f.translateX-.8*u)+","+b+") rotate(-90)":"translate("+y+","+(f.translateY-.8*u)+")")}if(this.xInfoEl.select("svg").node()){var p=this.xTitleEl.node().getBBox(),S=c.transform(this.xTitleEl.node()),_=x?p.x+S.translateX-1.4*u:p.x+S.translateX+p.width+.4*u;this.xInfoEl.select("svg").attr("width",u+"px").attr("height",u+"px"),this.xInfoEl.attr("transform","translate("+_+","+(S.translateY-.8*u)+")")}this._resizeDataWarning(),this.model.ui.chart.margin.set("left",d.left*this.activeProfile.leftMarginRatio,!1,!1)},_updateLineEqualXY:function(e){var t=this.model.marker.axis_x.which==this.model.marker.axis_y.which;if(this.lineEqualXY.classed("vzb-invisible",!t),t){var i=d3.min(this.yScale.domain().concat(this.xScale.domain())),a=d3.max(this.yScale.domain().concat(this.xScale.domain()));this.lineEqualXY.transition().duration(e||0).attr("y1",this.yScale(i)).attr("y2",this.yScale(a)).attr("x1",this.xScale(i)).attr("x2",this.xScale(a))}},_resizeDataWarning:function(){var e=this.dataWarningEl.select("text").style("font-size",null),t=e.node().getBBox().width+3*e.node().getBBox().height,i=this.width-this.xTitleEl.node().getBBox().width-this.activeProfile.infoElHeight,a=parseInt(e.style("font-size"))*i/t;e.style("font-size",t>i?a+"px":null);var r=e.node().getBBox();this.dataWarningEl.select("svg").attr("width",.75*r.height).attr("height",.75*r.height).attr("x",-r.width-1.2*r.height).attr("y",.65*-r.height),this.dataWarningEl.attr("transform","translate("+(this.model.locale.isRTL()?r.width+r.height:this.width)+","+(this.height+this.activeProfile.margin.bottom-this.activeProfile.xAxisTitleBottomMargin)+")")},updateMarkerSizeLimits:function(){var e=this.model.marker.size.extent||[0,1];if(!this.activeProfile)return c.warn("updateMarkerSizeLimits() is called before ready(). This can happen if events get unfrozen and getFrame() still didn't return data");var t=this.activeProfile.minRadiusPx,i=this.activeProfile.maxRadiusPx,a=c.radiusToArea(Math.max(i*e[0],t)),r=c.radiusToArea(Math.max(i*e[1],t)),s=a===r?[a,r]:d3.range(a,r,(r-a)/this.sScale.domain().length).concat(r);this.sScale.range(s)},redrawDataPointsOnlyColors:function(){var e=this;if(!this.entityBubbles)return c.warn("redrawDataPointsOnlyColors(): no entityBubbles defined. likely a premature call, fix it!");var t=void 0,i=this.dataKeys,a=this.KEYS,r=this.KEY,s=this.model.time.value;this.model.ui.chart.lockNonSelected&&this.someSelected&&(s=this.model.time.parse(""+this.model.ui.chart.lockNonSelected)),this.model.marker.getFrame(s,function(s){if(!e._frameIsValid(s))return c.warn("redrawDataPointsOnlyColor: empty data received from marker.getFrame(). doing nothing");t=e.frame,e.entityBubbles.each(function(l,o){var n=e.model.marker.isSelected(l),h=n?t.color[c.getKey(l,i.color)]:s.color[c.getKey(l,i.color)],d=null!=h?e.cScale(h):e.COLOR_WHITEISH;if(d3.select(this).style("fill",d),n){var u=c.find(e.model.marker.select,function(e){return c.getKey(e,a)==l[r]}),m=e.model.time.parse(""+u.trailStartTime);e.model.marker.getFrame(m,function(t){if(!t)return c.warn("redrawDataPointsOnlyColor: empty data received from marker.getFrames(). doing nothing");var a={};if(e.model.ui.chart.trails&&m-e.time!=0){var r=t.color[c.getKey(l,i.color)];a.scaledC0=null!=r?e.cScale(r):e.COLOR_WHITEISH}else a.scaledC0=d;e._labels.updateLabelOnlyColor(l,o,a)})}})})},redrawDataPointsOnlySize:function(){var e=this,t=void 0,i=this.dataKeys,a=this.KEYS,r=this.KEY,s=this.model.time.value;this.model.ui.chart.lockNonSelected&&this.someSelected&&(s=this.model.time.parse(""+this.model.ui.chart.lockNonSelected)),this.model.marker.getFrame(s,function(s){if(!e._frameIsValid(s))return c.warn("redrawDataPointsOnlySize: empty data received from marker.getFrame(). doing nothing");t=e.frame,e.entityBubbles.each(function(l,o){var n=e.model.marker.isSelected(l),h=n?t.size[c.getKey(l,i.size)]:s.size[c.getKey(l,i.size)];if(null!=h){var d=c.areaToRadius(e.sScale(h));if(d3.select(this).attr("r",d),n){var u=c.find(e.model.marker.select,function(e){return c.getKey(e,a)==l[r]}),m=e.model.time.parse(""+u.trailStartTime);e.model.marker.getFrame(m,function(t){if(!t)return c.warn("redrawDataPointsOnlySize: empty data received from marker.getFrames(). doing nothing");var a={};e.model.ui.chart.trails&&m-e.time!=0?a.scaledS0=c.areaToRadius(e.sScale(t.size[c.getKey(l,i.size)])):a.scaledS0=d,e._labels.updateLabelOnlyPosition(l,o,a)})}}})})},redrawDataPoints:function(e){var t=this;this.KEY;if(null==e&&(e=t.duration),this.model.ui.chart.lockNonSelected&&this.someSelected){var i=this.model.time.parse(""+this.model.ui.chart.lockNonSelected);this.model.marker.getFrame(i,function(i){if(!i)return c.warn("redrawDataPoints: empty data received from marker.getFrames(). doing nothing");t.entityBubbles.each(function(a,r){var s=t.model.marker.isSelected(a)?t.frame:i;t._updateBubble(a,s,r,d3.select(this),e)})})}else t.entityBubbles.each(function(i,a){t._updateBubble(i,t.frame,a,d3.select(this),e)});this._updateLineEqualXY(e)},_updateBubble:function(e,t,i,a,r){var s=this,l=this.dataKeys,o=!1,n=t.axis_y[c.getKey(e,l.axis_y)],h=t.axis_x[c.getKey(e,l.axis_x)],d=t.size[c.getKey(e,l.size)],u=t.label[c.getKey(e,l.label)],m=t.color[c.getKey(e,l.color)],g=t.size_label[c.getKey(e,l.size_label)];if(!u&&0!==u||!n&&0!==n||!h&&0!==h||!d&&0!==d){if(e.hidden||(e.hidden=!0,o=!0),o)if(r){var x=a.style("opacity");a.transition().duration(r).ease(d3.easeExp).style("opacity",0).on("end",function(){a.classed("vzb-invisible",e.hidden),a.style("opacity",x)})}else a.classed("vzb-invisible",e.hidden)}else{(e.hidden||a.classed("vzb-invisible"))&&(e.hidden=!1,o=!0);var v=c.areaToRadius(s.sScale(d));if(a.style("fill",null!=m?s.cScale(m):s.COLOR_WHITEISH),r)if(o){var f=a.style("opacity");a.classed("vzb-invisible",e.hidden),a.style("opacity",0).attr("cy",s.yScale(n)).attr("cx",s.xScale(h)).attr("r",v).transition().duration(r).ease(d3.easeExp).style("opacity",f)}else a.transition().duration(r).ease(d3.easeLinear).attr("cy",s.yScale(n)).attr("cx",s.xScale(h)).attr("r",v);else a.interrupt().attr("cy",s.yScale(n)).attr("cx",s.xScale(h)).attr("r",v).transition(),o&&a.classed("vzb-invisible",e.hidden);this.model.time.record&&s._export.write({type:"circle",id:e[KEY],time:this.model.time.value.getUTCFullYear(),fill:null!=m?s.cScale(m):s.COLOR_WHITEISH,cx:s.xScale(h),cy:s.yScale(n),r:v})}s._updateLabel(e,i,t,h,n,d,m,u,g,r,o)},_updateLabel:function(e,t,i,a,r,s,l,o,n,h,d){var u=this,m=this.KEYS,g=this.KEY;if(u.model.marker.isSelected(e)){var x={},v=c.find(u.model.marker.select,function(t){return c.getKey(t,m)==e[g]}),f=u.model.time.formatDate(u.time);this.model.ui.chart.trails&&v.trailStartTime!=f&&null!=v.trailStartTime||(this.model.ui.chart.trails&&null==v.trailStartTime&&(v.trailStartTime=f),x.labelX0=a,x.labelY0=r,x.scaledC0=null!=l?u.cScale(l):u.COLOR_WHITEISH,x.scaledS0=s||0===s?c.areaToRadius(u.sScale(s)):null);var y=u.model.time.parse(""+v.trailStartTime),b=u._getLabelText(i,this.labelNames,e,v.trailStartTime);d&&e.hidden&&u.model.ui.chart.trails&&y&&y<u.time&&(d=!1),e.hidden&&!u.model.ui.chart.trails&&(d=!0),this._labels.updateLabel(e,t,x,a,r,s,l,b,n,h,d)}},_getLabelText:function(e,t,i,a){return this.KEYS.map(function(a){return e[t[a]]?e[t[a]][i[a]]:i[a]}).join(", ")+(a||0===a?" "+a:"")},_setTooltip:function(e,t,i,a,r,s){if(e){var l={};if(s){var o=this.dataKeys,n=this.frame;l.valueY=n.axis_y[c.getKey(s,o.axis_y)],l.valueX=n.axis_x[c.getKey(s,o.axis_x)],l.valueS=n.size[c.getKey(s,o.size)],l.valueC=n.color[c.getKey(s,o.color)],l.valueLST=n.size_label[c.getKey(s,o.size_label)],l.labelText=this._getLabelText(n,this.labelNames,s,this.model.time.formatDate(this.time))}var h={};h.labelX0=this.xScale.invert(t),h.labelY0=this.yScale.invert(i),h.scaledS0=a,h.scaledC0=null,this._labels.setTooltip(s,e,h,l)}else this._labels.setTooltip()},_formatSTitleValues:function(e,t){var i=this.strings.unit.S,a=this.strings.unit.C,r=this.model.marker.size.getTickFormatter(),s=this.model.marker.color.getTickFormatter();return this.model.marker.color.isDiscrete()&&"constant"!==this.model.marker.color.use&&t&&this.model.marker.color.getColorlegendMarker()&&(t=this.model.marker.color.getColorlegendMarker().label.getItems()[t]||""),[r(e)+" "+i,t||0===t?s(t)+" "+a:this.translator("hints/nodata")]},_updateSTitle:function(e,t){if(this.activeProfile.hideSTitle&&this.model.ui.dialogs.sidebar.indexOf("colors")>-1&&this.model.ui.dialogs.sidebar.indexOf("size")>-1)return void this.sTitleEl.classed("vzb-invisible",!0);this.sTitleEl.classed("vzb-invisible")&&this.sTitleEl.classed("vzb-invisible",!1);var i="constant"!==this.model.marker.size.use,a="constant"!==this.model.marker.color.use,r=this.sTitleEl.select("text").style("font-size",null).text((i?this.translator("buttons/size")+": "+(e||this.strings.title.S):"")+(i&&a?", ":"")+(a?this.translator("buttons/colors")+": "+(t||this.strings.title.C):"")),s=r.node().getBBox().width,l=this.height-30,o=parseInt(r.style("font-size"))*l/s;r.style("font-size",s>l?o+"px":null)},selectDataPoints:function(){var e=this;this.KEY;c.isTouchDevice()?(e.model.marker.clearHighlighted(),e._labels.showCloseCross(null,!1)):(e._setTooltip(),e._setBubbleCrown()),e.someSelected=e.model.marker.select.length>0,e.nonSelectedOpacityZero=!1},_setBubbleCrown:function(e,t,i,a,r){null!=e?(this.bubbleCrown.classed("vzb-hidden",!1),this.bubbleCrown.select(".vzb-crown").attr("cx",e).attr("cy",t).attr("r",i).attr("fill",r?"none":a),this.bubbleCrown.selectAll(".vzb-crown-glow").attr("cx",e).attr("cy",t).attr("r",i+10).attr("stroke",a)):this.bubbleCrown.classed("vzb-hidden",!0)},_axisProjections:function(e){var t=this,i=this.TIMEDIM,a=this.dataKeys;null!=e?this.model.marker.getFrame(e[i],function(i){var r=i.axis_y[c.getKey(e,a.axis_y)],s=i.axis_x[c.getKey(e,a.axis_x)],l=i.size[c.getKey(e,a.size)],o=c.areaToRadius(t.sScale(l));!r&&0!==r||!s&&0!==s||!l&&0!==l||(t.model.ui.chart.whenHovering.showProjectionLineX&&t.xScale(s)>0&&t.xScale(s)<t.width&&t.yScale(r)+o<t.height&&t.projectionX.style("opacity",1).attr("y2",t.yScale(r)+o).attr("x1",t.xScale(s)).attr("x2",t.xScale(s)),t.model.ui.chart.whenHovering.showProjectionLineY&&t.yScale(r)>0&&t.yScale(r)<t.height&&t.xScale(s)-o>0&&t.projectionY.style("opacity",1).attr("y1",t.yScale(r)).attr("y2",t.yScale(r)).attr("x1",t.xScale(s)-o),t.model.ui.chart.whenHovering.higlightValueX&&t.xAxisEl.call(t.xAxis.highlightValue(s)),t.model.ui.chart.whenHovering.higlightValueY&&t.yAxisEl.call(t.yAxis.highlightValue(r)))}):(this.projectionX.style("opacity",0),this.projectionY.style("opacity",0),this.xAxisEl.call(this.xAxis.highlightValue("none")),this.yAxisEl.call(this.yAxis.highlightValue("none")))},highlightDataPoints:function(){var e=this,t=this.TIMEDIM,i=this.dataKeys,a=this.KEYS,r=this.KEY;if(this.someHighlighted=this.model.marker.highlight.length>0,this.updateBubbleOpacity(),1===this.model.marker.highlight.length){var s=c.clone(this.model.marker.highlight[0]);s[r]=c.getKey(s,a),e.model.ui.chart.lockNonSelected&&e.someSelected&&!e.model.marker.isSelected(s)?s[t]=e.model.time.parse(""+e.model.ui.chart.lockNonSelected):s[t]=e.model.time.parse(""+s.trailStartTime)||e.time,e.model.marker.getFrame(s[t],function(l){if(l){var o=e.xScale(l.axis_x[c.getKey(s,i.axis_x)]),n=e.yScale(l.axis_y[c.getKey(s,i.axis_y)]),h=c.areaToRadius(e.sScale(l.size[c.getKey(s,i.size)])),d=null!=l.color[c.getKey(s,i.color)]?e.cScale(l.color[c.getKey(s,i.color)]):e.COLOR_WHITEISH,u=!1,m=e._formatSTitleValues(l.size[c.getKey(s,i.size)],l.color[c.getKey(s,i.color)]);e._updateSTitle(m[0],m[1]),(o+h<0||o-h>e.width||n+h<0||n-h>e.height)&&(u=!0);var g="",x=!1;if(e.model.marker.isSelected(s)&&e.model.ui.chart.trails){g=e.model.time.formatDate(e.time);var v=c.find(e.model.marker.select,function(e){return c.getKey(e,a)==s[r]});x=g!==v.trailStartTime&&!d3.select(d3.event.target).classed("bubble-"+s[r]),g=g!==v.trailStartTime&&e.time===s[t]?g:""}else g=e.model.marker.isSelected(s)?"":e._getLabelText(l,e.labelNames,s);if(e._labels.highlight(null,!1),e._labels.highlight(s,!0),e.model.marker.isSelected(s)){var f=!s.trailStartTime||s.trailStartTime==e.model.time.formatDate(e.time);e._setBubbleCrown(o,n,h,d,f)}u||x||e._axisProjections(s),!g||u||x||e._setTooltip(g,o,n,h+3,d,s);var y=c.find(e.model.marker.select,function(e){return c.getKey(e,a)==s[r]});if(y){var b=c.clone(y);b.opacity=1,e._trails.run(["opacityHandler"],b)}}})}else this._axisProjections(),this._trails.run(["opacityHandler"]),e._updateSTitle(),this._setTooltip(),this._setBubbleCrown(),this._labels.highlight(null,!1)},_blinkSuperHighlighted:function(){var e=this;this.entityBubbles.classed("vzb-super-highlighted",function(t){return e.model.marker.isSuperHighlighted(t)})},updateBubbleOpacity:function(e){var t=this,i=this.model.marker.opacityHighlightDim,a=this.model.marker.opacityRegular,r=this.model.marker.opacitySelectDim;this.entityBubbles.style("opacity",function(e){return t.someHighlighted&&t.model.marker.isHighlighted(e)?1:t.someSelected?t.model.marker.isSelected(e)?1:r:t.someHighlighted?i:a});var s=t.model.marker.opacitySelectDim<.01;s!=this.nonSelectedOpacityZero&&this.entityBubbles.style("pointer-events",function(e){return t.someSelected&&s&&!t.model.marker.isSelected(e)?"none":"visible"}),this.nonSelectedOpacityZero=t.model.marker.opacitySelectDim<.01}});t.default=y},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=Vizabi,r=a.utils,s=Vizabi.Class.extend({init:function(e){this.context=e,this.dragRectangle=d3.drag(),this.zoomer=d3.zoom(),this.dragRectangle.subject(this.dragSubject()).on("start",this.drag().start).on("drag",this.drag().go).on("end",this.drag().stop),this.zoomer.filter(this.zoomFilter()).scaleExtent([.0625,1/0]).on("start",this.zoom().start).on("zoom",this.zoom().go).on("end",this.zoom().stop),this.zoomer.ratioX=1,this.zoomer.ratioY=1,e._zoomedXYMinMax={axis_x:{zoomedMin:null,zoomedMax:null},axis_y:{zoomedMin:null,zoomedMax:null}}},dragSubject:function(){var e=this.context;return function(t){return!d3.event.sourceEvent.ctrlKey&&!d3.event.sourceEvent.metaKey&&"plus"!==e.ui.cursorMode||"minus"===e.ui.cursorMode||("touchmove"===d3.event.sourceEvent.type||"touchstart"===d3.event.sourceEvent.type)&&(d3.event.sourceEvent.touches.length>1||d3.event.sourceEvent.targetTouches.length>1)?null:{x:d3.mouse(this)[0],y:d3.mouse(this)[1]}}},drag:function(){var e=this.context,t=this;return{start:function(t,i){this.origin={x:d3.mouse(this)[0],y:d3.mouse(this)[1]},e.zoomRect.classed("vzb-invisible",!1)},go:function(t,i){var a=this.origin,r={x:d3.event.x,y:d3.event.y};e.zoomRect.attr("x",Math.min(r.x,a.x)).attr("y",Math.min(r.y,a.y)).attr("width",Math.abs(r.x-a.x)).attr("height",Math.abs(r.y-a.y))},stop:function(i){if(e.zoomRect.attr("width",0).attr("height",0).classed("vzb-invisible",!0),this.target={x:d3.mouse(this)[0],y:d3.mouse(this)[1]},!(Math.abs(this.origin.x-this.target.x)<10||Math.abs(this.origin.y-this.target.y)<10)){var a=d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey||"plus"===e.ui.cursorMode;t._zoomOnRectangle(d3.select(this),this.origin.x,this.origin.y,this.target.x,this.target.y,a,500)}}}},zoomFilter:function(){var e=this.context;return function(t){var i=d3.event;return!i.ctrlKey&&!i.metaKey&&(("touchmove"===i.type||"touchstart"===i.type)&&(i.touches.length>1||i.targetTouches.length>1)||(!("wheel"!==i.type&&"mousewheel"!==i.type||!e.ui.zoomOnScrolling)||!("mousedown"!==i.type&&"touchstart"!==i.type||"plus"===e.ui.cursorMode||"minus"===e.ui.cursorMode||!e.ui.panWithArrow&&"hand"!==e.ui.cursorMode)))}},zoom:function(){var e=this.context,t=this.zoomer,i=this;return{start:function(){"plus"!==e.ui.cursorMode&&"minus"!==e.ui.cursorMode&&e.chartSvg.classed("vzb-zooming",!0),e.model._data.marker.clearHighlighted(),e._setTooltip()},go:function(){var a=d3.event.sourceEvent,s=d3.event.transform.k,l=[d3.event.transform.x,d3.event.transform.y],o=t.ratioY,n=t.ratioX;e.draggingNow=!0,(isNaN(s)||null==s)&&(s=t.scale),(isNaN(s)||null==s)&&(s=1),1===s&&null!==a&&(("wheel"===a.type||"mousewheel"===a.type)&&(a.deltaY||-a.wheelDelta)>0||"touchmove"===a.type&&a.touches.length>1)&&(t.ratioX=1,n=1,t.ratioY=1,o=1),(isNaN(l[0])||isNaN(l[1])||null==l[0]||null==l[1])&&(l=[0,0]);var c=t.scaleExtent()[0];s*o<c&&(o=c/s,t.ratioY=o),s*n<c&&(n=c/s,t.ratioX=n);var h=s*n<1,d=s*o<1;h?(l[0]<0&&(l[0]=0),l[0]>(1-s*n)*e.width&&(l[0]=(1-s*n)*e.width)):(l[0]>0&&(l[0]=0),l[0]<(1-s*n)*e.width&&(l[0]=(1-s*n)*e.width)),d?(l[1]<0&&(l[1]=0),l[1]>(1-s*o)*e.height&&(l[1]=(1-s*o)*e.height)):(l[1]>0&&(l[1]=0),l[1]<(1-s*o)*e.height&&(l[1]=(1-s*o)*e.height)),i.zoomSelection.property("__zoom",d3.zoomIdentity.translate(l[0],l[1]).scale(s));var u=e.width*s*n,m=e.height*s*o,g=[0*s*n+l[0],u+l[0]],x=[m+l[1],0*s*o+l[1]],v=e._rangeBump(g),f=e._rangeBump(x),y=(v[0]-g[0])*s*n,b=(v[1]-g[1])*s*n,p=(f[0]-x[0])*s*o,S=(f[1]-x[1])*s*o;g[0]+=y,g[1]+=b,x[0]+=p,x[1]+=S;var _=[0,e.width],z=[e.height,0],k=e._rangeBump(_),w=e._rangeBump(z);h?(g[0]<k[0]&&(l[0]=k[0]-y),g[1]>k[1]&&(l[0]=k[1]-b-u)):(g[0]>k[0]&&(l[0]=k[0]-y),g[1]<k[1]&&(l[0]=k[1]-b-u)),d?(x[0]>w[0]&&(l[1]=w[0]-p-m),x[1]<w[1]&&(l[1]=w[1]-S)):(x[0]<w[0]&&(l[1]=w[0]-p-m),x[1]>w[1]&&(l[1]=w[1]-S)),h?(g[0]<k[0]&&(g[1]+=Math.abs(g[0]-k[0]),g[0]=k[0]),g[1]>k[1]&&(g[0]-=Math.abs(g[1]-k[1]),g[1]=k[1])):(g[0]>k[0]&&(g[1]-=Math.abs(g[0]-k[0]),g[0]=k[0]),g[1]<k[1]&&(g[0]+=Math.abs(g[1]-k[1]),g[1]=k[1])),d?(x[0]>w[0]&&(x[1]-=Math.abs(x[0]-w[0]),x[0]=w[0]),x[1]<w[1]&&(x[0]+=Math.abs(x[1]-w[1]),x[1]=w[1])):(x[0]<w[0]&&(x[1]+=Math.abs(x[0]-w[0]),x[0]=w[0]),x[1]>w[1]&&(x[0]-=Math.abs(x[1]-w[1]),x[1]=w[1])),"ordinal"===e.model.marker.axis_x.scaleType?e.xScale.rangeBands(g):e.xScale.range(g),"ordinal"===e.model.marker.axis_y.scaleType?e.yScale.rangeBands(x):e.yScale.range(x);var M=function(e){return r.isDate(e)?e:+e.toFixed(2)},T=k,E=w;e._zoomedXYMinMax={axis_x:{zoomedMin:M(e.xScale.invert(T[0])),zoomedMax:M(e.xScale.invert(T[1]))},axis_y:{zoomedMin:M(e.yScale.invert(E[0])),zoomedMax:M(e.yScale.invert(E[1]))}},t.dontFeedToState||e.model.marker.set(e._zoomedXYMinMax,null,!1);var C=e.yAxis.labelerOptions(),K=e.xAxis.labelerOptions();C.limitMaxTickNumber=s*o<1.5?8:s*o*8,K.limitMaxTickNumber=s*n<1.5?8:s*n*8,C.transitionDuration=t.duration,K.transitionDuration=t.duration,e.xAxisEl.call(e.xAxis.labelerOptions(K)),e.yAxisEl.call(e.yAxis.labelerOptions(C)),e.redrawDataPoints(t.duration),e._trails.run("resize",null,t.duration),t.duration=0},stop:function(){e.chartSvg.classed("vzb-zooming",!1),e.draggingNow=!1,t.dontFeedToState||e.model.marker.set(e._zoomedXYMinMax,!0,!0),t.dontFeedToState=null}}},expandCanvas:function(e){var t=this.context;e||(e=t.duration);var i=d3.extent(r.values(t.frame.axis_x)),a=d3.extent(r.values(t.frame.axis_y));if(!i[0]&&0!==i[0]||!i[1]&&0!==i[1]||!a[0]&&0!==a[0]||!a[1]&&0!==a[1])return r.warn("panZoom.expandCanvas: X or Y min/max are broken. Aborting with no action");var s={x1:t.xScale(i[0]),y1:t.yScale(a[0]),x2:t.xScale(i[1]),y2:t.yScale(a[1])},l=[0,t.width],o=[t.height,0],n={x1:l[0],x2:l[1],y1:o[0],y2:o[1]};if(!t.isCanvasPreviouslyExpanded||s.x1<1*n.x1||s.x2>1*n.x2||s.y2<1*n.y2||s.y1>1*n.y1){if(t.isCanvasPreviouslyExpanded){var c=t._rangeBump(l),h=t._rangeBump(o);s.x1>c[0]&&(s.x1=c[0]),s.x2<c[1]&&(s.x2=c[1]),s.y1<h[0]&&(s.y1=h[0]),s.y2>h[0]&&(s.y2=h[1])}t.isCanvasPreviouslyExpanded=!0,this._zoomOnRectangle(t.element,s.x1,s.y1,s.x2,s.y2,!1,e)}else t.redrawDataPoints(e)},zoomToMaxMin:function(e,t,i,a,r,s){var l=this.context,o=e,n=t,c=i,h=a,d=l.xScale.domain(),u=l.yScale.domain();o<d[0]&&n<d[1]&&(o=d[0]),o>d[0]&&n>d[1]&&(n=d[1]),c<u[0]&&h<u[1]&&(c=u[0]),c>u[0]&&h>u[1]&&(h=u[1]);var m=[l.xScale(o),l.xScale(n)],g=[l.yScale(c),l.yScale(h)];this._zoomOnRectangle(l.element,m[0],g[0],m[1],g[1],!1,r,s)},_zoomOnRectangle:function(e,t,i,a,s,l,o,n){var c=this.context,h=this.zoomer,d=d3.zoomTransform(this.zoomSelection.node()),u=t,m=i,g=a,x=s;l&&d.translate(u-g,m-x);var v=[0,c.width],f=[c.height,0],y=c._rangeBump(v),b=c._rangeBump(f),p=h.scaleExtent()[0],S=h.scaleExtent()[1],_=void 0,z=void 0,k=void 0;if(u==g||m==x||y[0]==y[1]||b[0]==b[1])return r.warn("_zoomOnRectangle(): can not proceed because this may result in infinity zooms");Math.abs(u-g)>Math.abs(m-x)?(_=Math.abs(b[0]-b[1])/Math.abs(m-x)*d.k,_<p&&(h.ratioY*=_/d.k,_=p),_>S&&(_=S),z=Math.abs(y[0]-y[1])/Math.abs(u-g)*d.k/_*h.ratioX,k=h.ratioY):(_=Math.abs(y[0]-y[1])/Math.abs(u-g)*d.k,_<p&&(h.ratioX*=_/d.k,_=p),_>S&&(_=S),k=Math.abs(b[0]-b[1])/Math.abs(m-x)*d.k/_*h.ratioY,z=h.ratioX);var w=[(d.x-Math.min(u,g))/d.k/h.ratioX*_*z+(y[0]-v[0]),(d.y-Math.min(m,x))/d.k/h.ratioY*_*k+(b[1]-f[1])];h.dontFeedToState=n,h.ratioY=k||1,h.ratioX=z||1,h.duration=o||0,this.zoomSelection.call(h.transform,d3.zoomIdentity.translate(w[0],w[1]).scale(_))},zoomByIncrement:function(e,t){var i=(this.context,d3.zoomTransform(this.zoomSelection.node())),a=i.k,r=[i.x,i.y],s=d3.mouse(this.zoomSelection.node()),l=Math.log(a)/Math.LN2;"plus"!=e&&e||(l=Math.floor(l)+1),"minus"==e&&(l=Math.ceil(l)-1);var o=[(s[0]-r[0])/a,(s[1]-r[1])/a],n=this.zoomer.scaleExtent();a==n[0]&&(this.zoomer.ratioY=1,this.zoomer.ratioX=1),a=Math.max(n[0],Math.min(n[1],Math.pow(2,l))),o=[o[0]*a+r[0],o[1]*a+r[1]],r[0]+=s[0]-o[0],r[1]+=s[1]-o[1],this.zoomer.duration=t||0,this.zoomSelection.call(this.zoomer.transform,d3.zoomIdentity.translate(r[0],r[1]).scale(a))},resetZoomState:function(e){this.zoomer.ratioY=1,this.zoomer.ratioX=1,(e||this.zoomSelection).property("__zoom",d3.zoomIdentity)},reset:function(e,t){this.context.isCanvasPreviouslyExpanded=!1,this.zoomer.ratioY=1,this.zoomer.ratioX=1,this.zoomer.duration=t||0,(e||this.zoomSelection).call(this.zoomer.transform,d3.zoomIdentity)},rerun:function(e){this.context;(e||this.zoomSelection).call(this.zoomer.scaleBy,1)},zoomSelection:function(e){this.zoomSelection=e}});t.default=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=i(4),r=function(e){return e&&e.__esModule?e:{default:e}}(a),s=Vizabi,l=s.utils,o=Vizabi.Class.extend({init:function(e){this.context=e,this._isCreated=null,this.actionsQueue={},this.entityTrails={},this.trailsData=[],this.trailsInProgress={},this.activePromises={},this.trailTransitions={},this.delayedIterations={},this.drawingQueue={}},toggle:function(e){var t=this.context;e?t._trails.create().then(function(){t._trails.run(["findVisible","reveal","opacityHandler"])}):(t._trails.run("remove"),t.model.marker.select.forEach(function(e){delete e.trailStartTime}))},create:function(e){var t=this.context,i=this,a=t.KEYS,s=t.KEY,o=t.dataKeys,n=t.TIMEDIM;return this._isCreated=new Promise(function(c,h){if(t.model.ui.chart.trails){var d=t.model.time.getAllSteps(),u=[];e=null==e?t.model.marker.select:[e],i._clearActions(e),i.trailsData=t.model.marker.select.map(function(e){var t={status:"created",selectedEntityData:e};return a.forEach(function(i){return t[i]=e[i]}),t[s]=l.getKey(e,a),t}),i.trailTransitions={};var m=t.bubbleContainer.selectAll("g.vzb-bc-entity.entity-trail").data(i.trailsData,function(e){return e[s]});m.exit().remove(),m.enter().insert("g",function(e){return this.querySelector(".bubble-"+(0,r.default)(e[s]))}).attr("class",function(e){return"vzb-bc-entity entity-trail trail-"+e[s]}).merge(m).each(function(e,r){var c=this;u.push(new Promise(function(r,h){var u=d.map(function(t){return{t:t,key:e[s]}}),m=d3.select(c).selectAll("g").data(u).classed("vzb-invisible",!0);m.exit().remove(),i.entityTrails[e[s]]=m.enter().append("g").attr("class","vzb-bc-trailsegment vzb-invisible").on("mouseover",function(i,r){if(!l.isTouchDevice()){var c={};c[s]=i.key,c[n]=i.t,t._axisProjections(c),t._labels.highlight(e,!0);var h=t.model.time.formatDate(i.t),d=l.find(t.model.marker.select,function(t){return l.getKey(t,a)==e[s]});t.model.marker.getFrame(c[n],function(i){var a=t.xScale(i.axis_x[l.getKey(e,o.axis_x)]),r=t.yScale(i.axis_y[l.getKey(e,o.axis_y)]),s=l.areaToRadius(t.sScale(i.size[l.getKey(e,o.size)])),n=null!=i.color[l.getKey(e,o.color)]?t.cScale(i.color[l.getKey(e,o.color)]):t.COLOR_WHITEISH;h!==d.trailStartTime&&t._setTooltip(h,a,r,s+3,n),t._setBubbleCrown(a,r,s,n),t.model.marker.getModelObject("highlight").trigger("change",{size:i.size[l.getKey(e,o.size)],color:i.color[l.getKey(e,o.color)]})}),d3.select(this).style("opacity",1)}}).on("mouseout",function(e,i){l.isTouchDevice()||(t._axisProjections(),t._setTooltip(),t._setBubbleCrown(),t._labels.highlight(null,!1),t.model.marker.getModelObject("highlight").trigger("change",null),d3.select(this).style("opacity",t.model.marker.opacityRegular))}).each(function(e,t){var i=d3.select(this);i.append("circle"),i.append("line")}).merge(m),r()}))}),u.length>0?Promise.all(u).then(function(e){c(!0)}):c(!0)}}),this._isCreated},_addActions:function(e,t){var i=this.context,a=this,r=i.KEYS;e.forEach(function(e){var i=l.getKey(e,r);a.actionsQueue[i]||(a.actionsQueue[i]=[]),a.actionsQueue[i]=[].concat(a.actionsQueue[i].filter(function(e){return-1==t.indexOf(e)}),t)})},_clearActions:function(e){var t=this.context,i=this,a=t.KEYS;e.forEach(function(e){var t=l.getKey(e,a);i.actionsQueue[t]||(i.actionsQueue[t]=[]),i.actionsQueue[t]=[],i.drawingQueue[t]={},i.delayedIterations[t]={},i.activePromises[t]||(i.activePromises[t]=[]),l.forEach(i.activePromises[t],function(e,t){"pending"===e.status&&e.reject()}),i.trailsInProgress[t]=null,i.activePromises[t]=[]})},_getNextAction:function(e){return this.actionsQueue[e].shift()},run:function(e,t,i){var a=this.context,r=this,s=a.KEY;this._isCreated&&!a.model.time.splash&&("string"===typeof e&&(e=[e]),this._isCreated.then(function(){if(a.model.ui.chart.trails&&a.model.marker.select.length||"remove"==e){i||(i=0),t=null==t?a.model.marker.select:[t];for(var l=0;l<e.length;l++)-1!=["resize","recolor","remove"].indexOf(e[l])&&function(){var t=e.splice(l,1).pop();--l,r.trailsData.forEach(function(e){var l=r.entityTrails[e[s]];a._trails["_"+t](l,i,e)})}();0!=e.length&&(r._addActions(t,e),r.trailsData.forEach(function(t){-1!=e.indexOf("findVisible")&&(r.drawingQueue[t[s]]={},r.delayedIterations[t[s]]={});var l=r.entityTrails[t[s]];r.trailsInProgress[t[s]]||function e(o){var n=r._getNextAction(t[s]);if(n){r.trailsInProgress[t[s]]=n;var c=a._trails["_"+n](l,i,t);c&&c instanceof Promise?c.then(function(){r.trailsInProgress[t[s]]=null,e(o+1)},function(){r.trailsInProgress[t[s]]=null}):(r.trailsInProgress[t[s]]=null,e(o+1))}}(0)}))}}))},_remove:function(e,t,i){this.actionsQueue[i[this.context.KEY]]=[],e&&(d3.select(this.entityTrails[i[this.context.KEY]].node().parentNode).remove(),this.entityTrails[i[this.context.KEY]]=null)},_resize:function(e,t,i){var a=this.context;if(!a.model.time.splash){var r=!1;e.each(function(e,s){if(null!=e.valueY&&null!=e.valueX&&null!=e.valueS){var o=d3.select(this);if(t?o.select("circle").transition().duration(t).ease(d3.easeLinear).attr("cy",a.yScale(e.valueY)).attr("cx",a.xScale(e.valueX)).attr("r",l.areaToRadius(a.sScale(e.valueS))):o.select("circle").interrupt().attr("cy",a.yScale(e.valueY)).attr("cx",a.xScale(e.valueX)).attr("r",l.areaToRadius(a.sScale(e.valueS))).transition(),r||e.transparent||(r=!0,a._labels.updateLabelOnlyPosition(i,null,{scaledS0:l.areaToRadius(a.sScale(e.valueS))})),e.next){var n=e.next;if(null!=n&&null!=n.valueY&&null!=n.valueX){var c=Math.sqrt(Math.pow(a.xScale(e.valueX)-a.xScale(n.valueX),2)+Math.pow(a.yScale(e.valueY)-a.yScale(n.valueY),2));t?o.select("line").transition().duration(t).ease(d3.easeLinear).attr("x1",a.xScale(n.valueX)).attr("y1",a.yScale(n.valueY)).attr("x2",a.xScale(e.valueX)).attr("y2",a.yScale(e.valueY)).attr("stroke-dasharray",c).attr("stroke-dashoffset",l.areaToRadius(a.sScale(e.valueS))):o.select("line").interrupt().attr("x1",a.xScale(n.valueX)).attr("y1",a.yScale(n.valueY)).attr("x2",a.xScale(e.valueX)).attr("y2",a.yScale(e.valueY)).attr("stroke-dasharray",c).attr("stroke-dashoffset",l.areaToRadius(a.sScale(e.valueS))).transition()}}}})}},_recolor:function(e,t,i){var a=this.context;e.each(function(e,t){var i=d3.select(this),r="geo.world_4region"==a.model.marker.color.which?a.model.marker.color.getColorShade({colorID:e.valueC,shadeID:"shade"}):null!=e.valueC?a.cScale(e.valueC):a.COLOR_BLACKISH;i.select("circle").style("fill",null!=e.valueC?a.cScale(e.valueC):a.COLOR_WHITEISH),i.select("line").style("stroke",r)})},_opacityHandler:function(e,t,i){var a=this.context;e.each(function(e,t){d3.select(this).style("opacity",i.opacity||a.model.marker.opacityRegular)})},_findVisible:function(e,t,i){var a=this.context,r=this,s=a.KEY,o=a.dataKeys;return new Promise(function(t,n){new Promise(function(e,t){i.limits?e():a.model.marker.getEntityLimits(i[s]).then(function(t){i.limits=t,e()})}).then(function(){i.selectedEntityData.trailStartTime||(i.selectedEntityData.trailStartTime=a.model.time.formatDate(a.time));var n=a.model.time.parse(""+i.selectedEntityData.trailStartTime);if(a.time-n<0||i.limits.min-n>0){a.time-n<0?(i.selectedEntityData.trailStartTime=a.model.time.formatDate(d3.max([a.time,i.limits.min])),n=a.model.time.parse(""+i.selectedEntityData.trailStartTime)):(i.selectedEntityData.trailStartTime=a.model.time.formatDate(i.limits.min),n=a.model.time.parse(""+i.selectedEntityData.trailStartTime));var c=a._labels.cached[i[s]],h=a.frame.size[l.getKey(i,o.size)],d=a.frame.color[l.getKey(i,o.color)];c.labelX0=a.frame.axis_x[l.getKey(i,o.axis_x)],c.labelY0=a.frame.axis_y[l.getKey(i,o.axis_y)],c.scaledS0=h||0===h?l.areaToRadius(a.sScale(h)):null,c.scaledC0=null!=d?a.cScale(d):a.COLOR_WHITEISH,a._updateLabel(i,0,a.frame,c.labelX0,c.labelY0,h,d,a.frame.label[l.getKey(i,o.label)],a.frame.size_label[l.getKey(i,o.size_label)],0,!0)}e.each(function(t,r){var s=t.transparent;t.transparent=null==i.selectedEntityData.trailStartTime||t.t-a.time>0||n-t.t>0||i.selectedEntityData.trailStartTime-a.model.time.formatDate(a.time)>=0,(s!=t.transparent||Math.abs(a.model.time.formatDate(t.t)-a.model.time.formatDate(a.time))<2)&&(t.visibilityChanged=!0),t.transparent&&d3.select(e._groups[0][r]).classed("vzb-invisible",t.transparent)}),r.drawingQueue[i[s]]={},r.delayedIterations[i[s]]={},t()})})},_abortAnimation:function(){var e=this.context,t=this,i=e.KEY;t.trailsData.forEach(function(e){t.trailTransitions[e[i]]&&t.trailTransitions[e[i]].select("line").interrupt().transition()})},_reveal:function(e,t,i){var a=this.context;a.model.time.playing&&(t=a.model.time.delay);var r=this,s=(a.KEYS,a.KEY),o=a.dataKeys;i.status="reveal";var n=a.model.time.parse(""+i.selectedEntityData.trailStartTime),c=function(e,c,h,u){return new Promise(function(u,m){var g=d3.select(e._groups[0][c]),x=g.datum();if(h-c==1){if(x.transparent)return g.classed("vzb-invisible",x.transparent),u();if(!x.visibilityChanged)return u()}a.model.marker.getFrame(x.t,function(m){if("reveal"!=i.status)return u();if(!m)return u();if(x.valueY=m.axis_y[l.getKey(i,o.axis_y)],x.valueX=m.axis_x[l.getKey(i,o.axis_x)],x.valueS=m.size[l.getKey(i,o.size)],x.valueC=m.color[l.getKey(i,o.color)],null==x.valueY||null==x.valueX||null==x.valueS)return u();if(n&&n.toString()==x.t.toString()){var v=a._labels.cached[i[s]];v.labelX0=x.valueX,v.labelY0=x.valueY;var f=x.valueS;v.scaledS0=f||0===f?l.areaToRadius(a.sScale(f)):null,v.scaledC0=null!=x.valueC?a.cScale(x.valueC):a.COLOR_WHITEISH,a._updateLabel(i,c,m,x.valueX,x.valueY,x.valueS,x.valueC,m.label[l.getKey(i,o.label)],m.size_label[l.getKey(i,o.size_label)],0,!0)}if(g.select("circle").attr("cy",a.yScale(x.valueY)).attr("cx",a.xScale(x.valueX)).attr("r",l.areaToRadius(a.sScale(x.valueS))).style("fill",null!=x.valueC?a.cScale(x.valueC):a.COLOR_WHITEISH),g.select("line").attr("x2",a.xScale(x.valueX)).attr("y2",a.yScale(x.valueY)).attr("x1",a.xScale(x.valueX)).attr("y1",a.yScale(x.valueY)),a.time-x.t>0?(x.visibilityChanged=!1,g.classed("vzb-invisible",x.transparent)):g.classed("vzb-invisible",!0),!e._groups[0][h]||a.time.toString()==x.t.toString())return u();var y=d3.select(e._groups[0][h]),b=y.datum();b.previous=x,x.next=b;var p=b.t;a.time-b.t<0&&(x.visibilityChanged=!0,p=a.time),a.model.marker.getFrame(p,function(e){if("reveal"!=i.status)return u();if(!e||null==x.valueY||null==x.valueX||null==x.valueS)return u();if(null==e.axis_x[l.getKey(i,o.axis_x)]||null==e.axis_y[l.getKey(i,o.axis_y)])return u();b.valueY=e.axis_y[l.getKey(i,o.axis_y)],b.valueX=e.axis_x[l.getKey(i,o.axis_x)],b.valueS=e.size[l.getKey(i,o.size)],b.valueC=e.color[l.getKey(i,o.color)],r.trailTransitions[i[s]]=g;var n="geo.world_4region"==a.model.marker.color.which?a.model.marker.color.getColorShade({colorID:x.valueC,shadeID:"shade"}):null!=x.valueC?a.cScale(x.valueC):a.COLOR_BLACKISH,m=Math.sqrt(Math.pow(a.xScale(x.valueX)-a.xScale(b.valueX),2)+Math.pow(a.yScale(x.valueY)-a.yScale(b.valueY),2));return g.select("line").attr("stroke-dasharray",m).attr("stroke-dashoffset",l.areaToRadius(a.sScale(x.valueS))).style("stroke",n).transition().duration(t).ease(d3.easeLinear).attr("x1",a.xScale(b.valueX)).attr("y1",a.yScale(b.valueY)).attr("x2",a.xScale(x.valueX)).attr("y2",a.yScale(x.valueY)),h-c>1?(d(c,h),u()):u()})})})},h=function(r,s,n){return new Promise(function(c,h){var u=d3.select(e._groups[0][r]),m=d3.select(e._groups[0][s]),g=d3.select(e._groups[0][n]),x=u.datum(),v=m.datum(),f=g.datum();if(!x.previous&&!x.next||!v.previous&&!v.next)return c();a.model.marker.getFrame(f.t,function(e){if("reveal"!=i.status)return c();if(!e||"undefined"===typeof e.axis_x||null==e.axis_x[l.getKey(i,o.axis_x)]||"undefined"===typeof e.axis_y||null==e.axis_y[l.getKey(i,o.axis_y)])return l.warn("Frame for trail missed: "+f.t),c();if(f.valueY=e.axis_y[l.getKey(i,o.axis_y)],f.valueX=e.axis_x[l.getKey(i,o.axis_x)],f.valueS=e.size[l.getKey(i,o.size)],f.valueC=e.color[l.getKey(i,o.color)],f.previous=x,f.next=v,x.next=f,v.previous=f,null==f.valueY||null==f.valueX||null==f.valueS)return l.warn("Data for trail point missed: "+f.t),c();var h="geo.world_4region"==a.model.marker.color.which?a.model.marker.color.getColorShade({colorID:f.valueC,shadeID:"shade"}):null!=f.valueC?a.cScale(f.valueC):a.COLOR_BLACKISH,m=Math.sqrt(Math.pow(a.xScale(x.valueX)-a.xScale(f.valueX),2)+Math.pow(a.yScale(x.valueY)-a.yScale(f.valueX),2));if(u.select("line").transition().duration(t).ease(d3.easeLinear).attr("x1",a.xScale(f.valueX)).attr("y1",a.yScale(f.valueY)).attr("x2",a.xScale(x.valueX)).attr("y2",a.yScale(x.valueY)).attr("stroke-dasharray",m).attr("stroke-dashoffset",l.areaToRadius(a.sScale(x.valueS))).style("stroke",h),g.classed("vzb-invisible",f.transparent),!f.transparent){g.select("circle").attr("cy",a.yScale(f.valueY)).attr("cx",a.xScale(f.valueX)).attr("r",l.areaToRadius(a.sScale(f.valueS))).style("fill",null!=f.valueC?a.cScale(f.valueC):a.COLOR_WHITEISH);var y=Math.sqrt(Math.pow(a.xScale(f.valueX)-a.xScale(v.valueX),2)+Math.pow(a.yScale(f.valueY)-a.yScale(v.valueY),2));g.select("line").transition().duration(t).ease(d3.easeLinear).attr("x1",a.xScale(v.valueX)).attr("y1",a.yScale(v.valueY)).attr("x2",a.xScale(f.valueX)).attr("y2",a.yScale(f.valueY)).attr("stroke-dasharray",y).attr("stroke-dashoffset",l.areaToRadius(a.sScale(f.valueS))).style("stroke",h)}d(r,n,s),c()})})},d=function(e,t,a){var l=void 0;t-e>1&&(l=u(e,t),r.delayedIterations[i[s]][e]={first:e,next:t,medium:l}),a&&a-t>1&&(l=u(t,a),r.delayedIterations[i[s]][t]={first:t,next:a,medium:l})},u=function(e,t){return Math.round(e+(t-e)/2)},m=function(e,t,i){var r=[],s=0,o=0,n=d3.min([e.limits.max,a.time]),c=d3.max([e.limits.min,a.model.time.parse(""+e.selectedEntityData.trailStartTime)]);return l.forEach(t._groups[0],function(e,t){var l=e.__data__;l.t-c==0?s=t:l.t-n==0?o=t:l.t>c&&l.t<n&&(a.model.time.formatDate(l.t)%i==0||l.next&&l.previous)&&r.push(t)}),r.unshift(s),o>0&&r.push(o),r},g=function(){return new Promise(function(e,t){Object.keys(r.drawingQueue[i[s]]).length>0?function t(){var a=Object.keys(r.drawingQueue[i[s]])[Math.floor(Math.random()*Object.keys(r.drawingQueue[i[s]]).length)],l=JSON.parse(JSON.stringify(r.drawingQueue[i[s]][a]));delete r.drawingQueue[i[s]][a],h(l.first,l.next,l.medium).then(function(){Object.keys(r.drawingQueue[i[s]]).length>0?t():e()})}(r.drawingQueue[i[s]]):e()})};return new Promise(function(t,l){var o=function e(){g().then(function(){if(0==Object.keys(r.delayedIterations[i[s]]).length)return t();r.drawingQueue[i[s]]=r.delayedIterations[i[s]],r.delayedIterations[i[s]]={},e()},function(){return t()})};if(a.model.marker.framesAreReady())!function e(i,a){if(a<0||a>=i._groups[0].length)return t();c(i,a,a+1).then(function(){e(i,a+1)},function(){return t()})}(e,0);else{r.delayedIterations[i[s]]={},r.drawingQueue[i[s]]={};var n=m(i,e,50),h=[];if(n.length<=1)return t();r.delayedIterations[i[s]]={};for(var d=0;d<n.length-1;d++)h.push(c(e,n[d],n[d+1]));Promise.all(h).then(function(){0==Object.keys(r.delayedIterations[i[s]]).length?t():(r.drawingQueue[i[s]]=r.delayedIterations[i[s]],r.delayedIterations[i[s]]={},o())},function(){t()})}})}});t.default=o},function(e,t,i){(function(t){!function(t,i){e.exports=i(t)}("undefined"!=typeof t?t:this,function(e){if(e.CSS&&e.CSS.escape)return e.CSS.escape;var t=function(e){if(0==arguments.length)throw new TypeError("`CSS.escape` requires an argument.");for(var t,i=String(e),a=i.length,r=-1,s="",l=i.charCodeAt(0);++r<a;)t=i.charCodeAt(r),s+=0!=t?t>=1&&t<=31||127==t||0==r&&t>=48&&t<=57||1==r&&t>=48&&t<=57&&45==l?"\\"+t.toString(16)+" ":(0!=r||1!=a||45!=t)&&(t>=128||45==t||95==t||t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122)?i.charAt(r):"\\"+i.charAt(r):"�";return s};return e.CSS||(e.CSS={}),e.CSS.escape=t,t})}).call(t,i(7))},function(e,t){},function(e,t){e.exports='\x3c!-- Bubble Chart Component --\x3e\n<div class="vzb-bubblechart">\n    <svg class="vzb-bubblechart-svg vzb-export">\n        <g class="vzb-bc-graph">\n            <g class="vzb-bc-year"></g>\n\n            <svg class="vzb-bc-axis-x"><g></g></svg>\n            <svg class="vzb-bc-axis-y"><g></g></svg>\n            <line class="vzb-bc-projection-x"></line>\n            <line class="vzb-bc-projection-y"></line>\n\n            <svg class="vzb-bc-bubbles-crop">\n                <g class="vzb-zoom-selection"></g>\n                <line class="vzb-bc-line-equal-xy vzb-invisible"></line>\n                <rect class="vzb-bc-eventarea"></rect>\n                <g class="vzb-bc-trails"></g>\n                <g class="vzb-bc-bubbles"></g>\n                <g class="vzb-bc-lines"></g>\n                <g class="vzb-bc-bubble-crown vzb-hidden">\n                    <circle class="vzb-crown-glow"></circle>\n                    <circle class="vzb-crown"></circle>\n                </g>\n            </svg>\n\n            <g class="vzb-bc-axis-y-subtitle"></g>\n            <g class="vzb-bc-axis-x-subtitle"></g>\n            <g class="vzb-bc-axis-y-title"></g>\n            <g class="vzb-bc-axis-x-title"></g>\n            <g class="vzb-bc-axis-s-title"></g>\n            <g class="vzb-bc-axis-c-title"></g>\n\n            <g class="vzb-bc-axis-y-info vzb-noexport"></g>\n            <g class="vzb-bc-axis-x-info vzb-noexport"></g>\n\n            <svg class="vzb-bc-labels-crop">\n                <g class="vzb-bc-labels"></g>\n            </svg>\n\n            <g class="vzb-data-warning vzb-noexport">\n                <svg></svg>\n                <text></text>\n            </g>\n\n            <rect class="vzb-bc-zoom-rect"></rect>\n        </g>\n    </svg>\n    <svg>\n        <defs>\n            <filter id="vzb-glow-filter" x="-50%" y="-50%" width="200%" height="200%">\n                <feGaussianBlur in="SourceGraphic" stdDeviation="2"></feGaussianBlur>\n            </filter>\n        </defs>\n    </svg>\n    \x3c!-- This could possibly be another component --\x3e\n    <div class="vzb-tooltip vzb-hidden vzb-tooltip-mobile"></div>\n</div>\n'},function(e,t){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(e){"object"===typeof window&&(i=window)}e.exports=i},function(e,t,i){e.exports=i(0)}]);
//# sourceMappingURL=bubblechart.min.js.map